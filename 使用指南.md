# Wuying AgentBay SDK 使用指南

## 快速开始

### 安装
```bash
# Python
pip install wuying-agentbay-sdk

# TypeScript  
npm install wuying-agentbay-sdk

# Golang
go get github.com/aliyun/wuying-agentbay-sdk/golang/pkg/agentbay
```

### 初始化
```python
# 设置API密钥: export AGENTBAY_API_KEY="your_key"
from agentbay import AgentBay
agent_bay = AgentBay(api_key="your_key")  # 或从环境变量读取
```

## 核心功能

### 1. 会话管理
```python
# 创建会话 - image_id可选: linux_latest, browser_latest, code_latest, windows_latest
from agentbay.session_params import CreateSessionParams
params = CreateSessionParams(image_id="browser_latest", context_id="ctx_123")  
result = agent_bay.create(params)
session = result.session

# 获取会话链接
link = session.get_link()  # 默认链接
link_custom = session.get_link("https", 443)  # 指定协议和端口

# 列出所有会话
sessions = agent_bay.list()

# 删除会话(重要:使用完必须删除)
agent_bay.delete(session)
```

### 2. 命令执行
```python
# 执行Shell命令
result = session.command.execute_command("ls -la")
if result.success:
    print(result.output)  # 命令输出
    print(result.exit_code)  # 退出码

# 执行Python代码
result = session.code.execute_python("print('Hello')")

# 执行JavaScript代码  
result = session.code.execute_javascript("console.log('Hello')")
```

### 3. 文件操作
```python
fs = session.file_system

# 基础操作
fs.write_file("/tmp/test.txt", "content", mode="overwrite")  # mode: overwrite/append
result = fs.read_file("/tmp/test.txt")
fs.edit_file("/tmp/test.txt", [{"oldText": "old", "newText": "new"}])
fs.move_file("/source", "/dest")
fs.delete_file("/tmp/test.txt")

# 目录操作
fs.create_directory("/tmp/mydir")
entries = fs.list_directory("/tmp").entries  # [{name, isDirectory, size}]
info = fs.get_file_info("/tmp/test.txt").file_info

# 批量操作
fs.search_files("/tmp", "pattern")  # 搜索文件
contents = fs.read_multiple_files(["/file1", "/file2"]).contents  # {path: content}

# 大文件处理(自动分块,默认1MB)
fs.write_large_file("/tmp/large.txt", large_content, chunk_size=50*1024)  # 自定义50KB块
content = fs.read_large_file("/tmp/large.txt", chunk_size=80*1024).content
```

### 4. 浏览器自动化
```python
from agentbay.browser.browser import BrowserOption
from playwright.async_api import async_playwright

# 初始化浏览器
await session.browser.initialize_async(BrowserOption())
endpoint_url = session.browser.get_endpoint_url()

# 使用Playwright连接
async with async_playwright() as p:
    browser = await p.chromium.connect_over_cdp(endpoint_url)
    page = await browser.new_page()
    
    # 网页操作
    await page.goto("https://www.aliyun.com")
    await page.fill("input.search", "AgentBay")
    await page.keyboard.press("Enter")
    await page.wait_for_selector(".search-result")
    results = await page.locator(".search-result").all()
    
    # 截图
    await page.screenshot(path="screenshot.png")
    await browser.close()
```

### 5. 上下文管理(持久化存储)
```python
# 创建/获取上下文
context = agent_bay.context_manager.create_context("my_context")
context = agent_bay.context_manager.get_context("ctx_id")

# 存储数据
context.set("key", "value")
value = context.get("key")
context.delete("key")

# 列出所有上下文
contexts = agent_bay.context_manager.list_contexts(page_size=10, page_number=1)

# 同步上下文到会话
sync_result = session.context_sync.sync_context("ctx_id", sync_mode="full")  # full/incremental

# 删除上下文
agent_bay.context_manager.delete_context("ctx_id")
```

### 6. 应用和窗口管理
```python
# 应用操作
apps = session.application.list_applications()
session.application.start_application("app_name")
session.application.stop_application("app_name")

# 窗口操作
windows = session.window.list_windows()
session.window.activate_window("window_id")
session.window.minimize_window("window_id")
session.window.resize_window("window_id", 1024, 768)
screenshot = session.window.capture_window("window_id")
```

### 7. 标签管理
```python
# 设置标签
session.set_label("env", "production")
session.set_label("owner", "team-a")

# 获取标签
label_value = session.get_label("env")

# 按标签筛选会话
sessions = agent_bay.list(labels={"env": "production"})
```

### 8. OSS集成
```python
oss = session.oss

# 上传/下载
oss.upload_file("/local/file.txt", "oss://bucket/path/file.txt")
oss.download_file("oss://bucket/path/file.txt", "/local/file.txt")

# 列出对象
objects = oss.list_objects("oss://bucket/path/")

# 删除对象
oss.delete_object("oss://bucket/path/file.txt")
```

### 9. Agent模块(自动化代理)
```python
from agentbay.agent import Agent

agent = Agent(session)

# 定义任务
task = {
    "name": "web_search",
    "steps": [
        {"action": "navigate", "url": "https://google.com"},
        {"action": "search", "query": "AgentBay SDK"},
        {"action": "extract", "selector": ".search-result"}
    ]
}

# 执行任务
result = agent.execute_task(task)
```

### 10. VPC会话(私有网络)
```python
# 创建VPC会话
params = CreateSessionParams(
    image_id="linux_latest",
    vpc_config={
        "vpc_id": "vpc-xxx",
        "vswitch_id": "vsw-xxx",
        "security_group_id": "sg-xxx"
    }
)
vpc_session = agent_bay.create(params).session
```

## 最佳实践

### 错误处理
```python
from agentbay.exceptions import AgentBayError

try:
    session = agent_bay.create(params).session
    # 使用session
except AgentBayError as e:
    print(f"AgentBay错误: {e}")
finally:
    if session:
        agent_bay.delete(session)  # 确保清理
```

### 异步操作
```python
import asyncio

async def async_operations():
    # 浏览器必须异步初始化
    await session.browser.initialize_async(BrowserOption())
    
    # 异步命令执行
    result = await session.command.execute_command_async("long_running_task")

asyncio.run(async_operations())
```

### 批处理优化
```python
# 批量读取优于循环单个读取
files = [f"/tmp/file{i}.txt" for i in range(10)]
contents = fs.read_multiple_files(files).contents  # 一次请求

# 大文件自动分块
fs.write_large_file("/tmp/huge.txt", huge_data)  # SDK自动处理分块
```

## 注意事项

1. **会话必须手动删除** - SDK不会自动清理,避免资源泄露
2. **API密钥安全** - 使用环境变量,勿硬编码
3. **文件大小限制** - 单次操作超1MB自动分块,使用large_file方法
4. **浏览器需异步** - browser.initialize必须await
5. **错误恢复** - 所有方法返回包含success/error的结构化响应
6. **并发限制** - 单账号最多10个并发会话
7. **超时设置** - 长时间操作设置合理timeout
8. **上下文同步** - incremental模式性能更好,full模式数据完整

## 环境支持

- **linux_latest**: 标准Linux环境,支持shell命令
- **browser_latest**: 包含Chrome浏览器,支持Playwright
- **code_latest**: 开发环境,预装Python/Node.js/Go
- **windows_latest**: Windows环境
- **mobile_latest**: Android环境,支持ADB命令

## 性能建议

- 重用会话而非频繁创建/删除
- 使用上下文持久化避免重复初始化  
- 大文件操作调整chunk_size平衡速度和内存
- 批量操作减少API调用次数
- 异步执行提高并发性能